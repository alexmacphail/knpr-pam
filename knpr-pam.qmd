---
title: "Report on the use of passive acoustic monitoring in Kluane National Park Reserve"
format:
  html:
    code-overflow: wrap
navbar: right
theme: cosmo
date: "`r format(Sys.time(), '%d %B, %Y')`"
author: 
  - name: "Alex MacPhail"
    affiliation: "Biodiversity Pathways Ltd."
  - name: "Camila Hurtado"
    affiliation: "Biodiversity Pathways Ltd."
  - name: "Jeni Rudisill"
    affiliation: "Parks Canada"
  - name: "Lisa Larson"
    affiliation: "Parks Canada"
editor: visual
bibliography: references.bib
nocite: '@*'
toc: true
toc-depth: 2
toc-expand: true
toc-location: left
styles: styles.css
github: https://github.com/biodiversitypathways/knpr-pam
---

![](./assets/kluane-banner.jpg){style="float:left`;" fig-alt="Photo of a glacier" fig-align="center"}

```{r}
#| label: Load packages and authenticate to WildTrax
#| include: false
#| echo: true
#| eval: true
#| warning: false
#| message: false

library(tidyverse)
library(leaflet)
library(wildrtrax)
library(sf)
library(ggridges)
library(scales)
library(kableExtra)
library(plotly)
library(DT)
library(vegan)
library(pwr)

wt_auth()

load('knpr.RData')
#save.image('knpr.RData')
#cirrus_knpr_recs  <- readRDS('./assets/knprcirrus.RDS')
```

# Abstract

Passive acoustic monitoring has proven to be a valuable tool for studying vocalizing species. Environmental sensors are becoming increasingly easy to program and can autonomously generate extensive data sets of the soundscape, becoming an invaluable resource for ecological integrity monitoring. Kluane National Park Reserve deployed autonomous recording units (ARUs) at `r locs_summary |> filter(Treatment == "Ecological Integrity") |> tally()` locations (`r locs_summary |> filter(Treatment == "Ecological Integrity") |> select(Site) |> distinct() |> pull() |> paste(collapse = ", ")`) as part of the Ecological Integrity Monitoring Program (2009–2024) and `r locs_summary |> filter(grepl("Prescribed Burn",Treatment)) |> tally()` contributing to the National Prescribed Burn Protocol. ARUs detected `r nrow(common)` species, including both birds and mammals. Trends show relatively stable abundance at the Auriol Site and consistent species richness across years. Species richness was equal in treatments versus controls in pre-burn monitoring areas, and would be expected to change after burns take place. While bat data revealed some positive detections of Little Brown Bat, significant deployement improvements are needed to maximize detection rates and data quality. Sustained monitoring of these areas following prescribed burns, incorporating enhanced equipment protocols to optimize detections of bats, as well as broader schedule in recording data collection, will optimize the effectiveness of the ongoing monitoring program. Additional sites can increase the power and robustness of the overall monitoring program with future data collection can be facilitated by more advanced models and analyses.

::: {.callout-note collapse="true" style="background-color: #f4f4f4; padding: 20px;"}
This report is dynamically generated, meaning its results may evolve with the addition of new data or further analyses. For the most recent updates, refer to the publication date and feel free to reach out to the authors.
:::

# Land Acknowledgement

In the spirit of Reconciliation, we respectfully acknowledge that the lands of Kluane National Park Reserve where this study took place are the traditional territories of the Southern Tutchone people represented in the Kluane region by the Champagne and Aishihik First Nations and the Kluane First Nation. Champagne and Aishihik First Nations, Kluane First Nation and Parks Canada are jointly responsible for the management of Kluane's natural and cultural resources.

# Introduction

Human activities have been identified as key pressures and contributors to the global decline in forest wildlife (@allan2017recent). The repercussions of habitat fragmentation (@fahrig2003effects) and loss (@hanski2011habitat), climate change (@mantyka2012interactions, @sattar2021review, @abrahms2023climate), and increased access to sensitive areas exert direct and indirect pressures on forest biodiversity, particularly in managed regions in Canada (@lemieux2011state).

Forests of the Kluane National Park and Reserve are currently experiencing a severe fire deficit, with a 71% departure in the estimated area burned from the historic area burned (see [2017 Kluane National Park and Reserve State of the Park Technical Compendium](https://parks.canada.ca/agence-agency/bib-lib/rapports-reports/~/media/4334d912b761468398c45fa006552cd1.ashx)). The area also saw a significant spruce bark beetle infestation over the 1990s to 2000s. It is estimated that over 49,000 ha were affected and, on average, almost half of the mature spruce trees were killed in affected forests. Given that climate change scenarios consistently indicate hotter temperatures and a longer growing season for Kluane forests, disturbance from wildfires, insect outbreaks, and other direct and indirect effects, are likely to cause major changes to the forest structure in the future (@gahbauer2022projected). A project funded within the Conservation and Restoration (CoRe) program aimed to achieve measurable conservation gains towards the effective and enduring restoration of ecological integrity: *Dákeyi ukaanathį̀ jè: All of you watch over our country with your heart* is a 5-year project with objectives to increase the resilience of Kluane forests and restore fire to its ecosystems. Western and Indigenous knowledge systems will inform a long-term restoration plan, supported by the learnings from prescribed burn trials and alternate/complementary conservation activities. Autonomous recording units or ARUs are compact environmental sensors that are designed to passively record the environment (@aru-overview), capturing vocalizing species like birds and amphibians, which is growing in use across the globe (@lots-of-pam). This technology enables resource managers to conduct prolonged surveys with minimal human interference. The subsequent data collected by these units contribute valuable information to ecological integrity metrics such as species richness, diversity, occupancy, and trends over time. This data aids decision-making and management within the Park. Given the rapid and ease of accumulating large amounts of data from these units, maintaining a high standard of data integrity is paramount to ensure future data interoperability and sharing. [WildTrax](https://www.wildtrax.ca) is an online platform developed by the [Alberta Biodiversity Monitoring Institute (**ABMI**)](https://abmi.ca) for users of environmental sensors to help addresses these big data challenges by providing solutions to standardize, harmonize, and share data. In 2023, Kluane initiated a program incorporating ARUs for passive acoustic monitoring of bird populations in forested habitats, as an integral component of the forest health measures.

The objectives of this report are to:

-   Describe the data management and processing procedures for the acoustic data collected;
-   Utilize traditional human tagging to detect and count avian species heard on recordings;
-   Utilize standardized automated processing techniques to evaluate species detected via ultrasonic recordings;
-   Define straightforward methods for evaluating abundance, species richness and species diversity and trends over time;
-   Offer recommendations for ongoing monitoring approaches to contribute to the assessment of ecological integrity in forest ecosystems and prescribed burn management in the park;
-   Facilitate data publication to the public, resource managers, academic institutions, and any other relevant agencies

# Methods

## Ecological integrity monitoring

Forest bird monitoring commenced in 2009. Acoustic monitoring surveys were conducted at Auriol Trail and Quill Creek to assess avian activity during the core breeding season in May and June to align with the Alaska Landbird Monitoring Strategy protocol (@handel2004alaska). Surveys were conducted in the white spruce (*Picea glauca*) dominated forests along the Auriol Trail. Along Auriol Trail, from 2009 to 2014 surveys were conducted annually, proceeding by biennial surveys in 2015, 2017, 2019 and returning to annual surveys in 2020. Quill Creek was surveyed in 2019 and 2022 only; due to the lack of repetition in these surveys, only Auriol Trail was included in the proceeding EI measures. Each transect consisted of twelve survey points spaced approximately 200 m apart. These surveys involved a standardized 10-minute recording at each site, enabling consistent data collection for comparisons across years and locations, with each location sufficiently spaced to ensure independence for most species. The recordings were analyzed to capture the presence and abundance of breeding bird species. Two experienced observers visited the points along the Auriol Trail, and listened for 10 minutes independently at each point, recording all the birds heard and seen within 100 m.

```{r}
#| label: Download data from WildTrax
#| warning: false
#| message: false
#| echo: true
#| eval: false
#| include: true
#| code-fold: true

knpr_projects <- wildrtrax::wt_get_download_summary(sensor = 'ARU') |>
  filter(grepl('Kluane', project)) |>
  select(project_id) |>
  pull()

knpr_main <-
  map_dfr(
    .x = knpr_projects,
    .f = ~ wildrtrax::wt_download_report(
      project_id = .x,
      sensor_id = "ARU",
      weather_cols = T,
      reports = "main"
    )
  )

knpr_main <- bind_rows(knpr_main, old_standardized)
```

```{r, echo=F}
#| echo: true
#| eval: true
#| warning: false
#| message: false
#| include: true
#| code-fold: true
#| fig-align: center
#| fig-cap: Locations from Kluane National Park Reserve ARU Monitoring Program
#| label: fig-aru-monitoring-locations

knpr_locs <- knpr_main |>
  mutate(year = year(recording_date_time)) |>
  select(location, latitude, longitude, year) |>
  distinct() |>
  drop_na() |>
  mutate(type = case_when(grepl('BAT',location) ~ "Bat", TRUE ~ "Bird")) |>
  sf::st_as_sf(coords = c("longitude","latitude"), crs = 4326)

locs_summary <- knpr_locs |>
  st_drop_geometry() |>
  group_by(location, year) |>
  mutate(value = row_number()) |>
  ungroup() |>
  arrange(year) |>
  pivot_wider(names_from = year, values_from = value, values_fill = 0) |>
  mutate(Site = case_when(grepl('AC-*',location) ~ "Alder Creek",
                          grepl('JR-*',location) ~ "Jarvis River",
                          grepl('BAT',location) ~ "Bat Monitoring",
                          grepl('^Q',location) ~ "Quill Creek",
                          grepl('^A[0-9]+',location) ~ "Auriol Trail",
                          TRUE ~ NA_character_),
         Treatment = case_when(str_detect(location, '-T') ~ "Prescribed Burn - Treatment",
                               str_detect(location, '-C') ~ "Prescribed Burn - Control",
                               grepl('BAT',location) ~ "Bat Monitoring",
                               TRUE ~ "Ecological Integrity")) |>
  rename('Location' = location) |>
  rename('Target' = type)

kluane_shp <- read_sf('./assets/National_Parks_and_National_Park_Reserves_of_Canada_Legislative_Boundaries.shp') |>
  filter(grepl('KLUANE',adminAreaN))
kluane_shp <- st_transform(kluane_shp, st_crs(knpr_locs)) |> st_make_valid()

palette <- colorFactor(palette = "viridis", domain = knpr_locs$type)

leaflet() %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addPolygons(
    data = kluane_shp,
    fillColor = "#29ABE2",
    color = "black",
    weight = 1,
    fillOpacity = 0.4,
    popup = ~paste("Park:", adminAreaN)
  ) %>%
  addCircleMarkers(
    data = knpr_locs,
    color = ~palette(type),  # Color based on "type"
    popup = ~paste("Location:", knpr_locs$location, "<br>", knpr_locs$Target),
    radius = 5  # Adjust marker size
  ) %>%
  addMeasure(primaryLengthUnit = "meters", primaryAreaUnit = "sqmeters") %>%
  addMiniMap(position = "bottomleft") %>%
  addLegend(
    "bottomright",
    pal = palette,
    values = knpr_locs$Target,  # Use the same domain as the palette
    title = "Kluane Sites and Projects",
    opacity = 1
  )
  
```

## Pre-burn monitoring for prescribed fire

Data were collected during spring and summer of 2023-2024. A total of 10 locations were surveyed, encompassing sites at Alder Creek (`AC-`) and Jarvis River (`JR-`), each with five locations. In each site, 3 locations were designated for a prescribed burn in 2025 ("Treatment", e.g. `AC-T1`), with 2 locations serving as unburned controls (e.g. `JR-C1`). ARUs were deployed at locations throughout the season, as outlined in Table 1 (@tbl-loc-summary) and depicted in @fig-aru-monitoring-locations. ARUs were deployed at the onset of the breeding bird season (May-June) and rotated among locations until retrieval in July-August. Each ARU recorded for an average of 5.4 days. Recording schedules were standardized, comprising morning sessions at 05:30, 06:30, and 07:30, and evening sessions at 22:45 and 23:45.

```{r}
#| warning: false
#| echo: true
#| eval: true
#| message: false
#| include: true
#| label: tbl-loc-summary
#| collapse: true
#| code-fold: true
#| tbl-cap: Locations surveyed across years. Ones indicated a deployment in that year for that location. Note the absence of AC-C1, AC-T3, JR-BAT in 2023 which failed to collect data.

kable(locs_summary, caption = "Location summary for ARUs deployed in Kluane National Park") |>
  kable_styling(fixed_thead = TRUE) |>
  scroll_box(width = "100%", height = "400px")

```

```{r}
#| warning: false
#| echo: false
#| eval: false
#| message: false
#| include: true
#| results: hide

# Recording statistics
all_recs <- wt_get_recordings('KNPR') |>
  select(location, recording_date_time) |>
  as_tibble() |>
  distinct() |>
  drop_na() |>
  unnest() |>
  mutate(recording_date_time = ymd_hms(recording_date_time),
         julian = yday(recording_date_time),
         hour = hour(recording_date_time),
         year = year(recording_date_time),
         month= month(recording_date_time, label = T))

count_recs <- nrow(all_recs)

average_deployment <- all_recs |>
  group_by(location, year) |>
  summarise(count = n_distinct(julian)) |>
  ungroup() |>
  summarise(mean = round(mean(count), 2),
            sd = round(sd(count), 2))

all_recs_plot <- all_recs |>
  rename("Location" = location) |>
  rename("Day of Year" = julian) |>
  mutate(type = case_when(
    grepl("BAT", Location) ~ "Bat monitoring",              
    grepl("^AC-T|^JR-T|^AC-C|^JR-C", Location) ~ "Pre-burn monitoring",     
    TRUE ~ "Ecological integrity"
  )) |>
  group_by(Location, `Day of Year`) |>
  add_tally() |>
  ungroup() |>
  ggplot(aes(x = `Day of Year`, fill = type)) +
  geom_density() +
  labs(x = "Day of Year",
       y = "Proportion of total Recordings",
       color = "Year") +
  theme_bw() +
  xlim(140, 200) +
  scale_fill_viridis_d(option = "mako", alpha = 0.7)
  
```

```{r}
#| warning: false
#| echo: false
#| eval: true
#| message: false
#| include: true
#| results: hide
#| label: fig-recs-plot
#| fig-cap: Proportion of total recordings collected across programs relative to day of year (julian date)

all_recs_plot

```

## Data processing

Data from 2015 - 2024 were processed in WildTrax with the data between 2009 - 2014 having been acquired directly from legacy spreadsheets. Audio data were transferred to the University of Alberta Data Centre in Edmonton for redundant data storage under [WildTrax](https://wildtrax.ca). A summary table of the recordings were collected can be found in [FIGURE]. The recordings were standardized to ensure adherence to the naming convention of `LOCATION_DATETIME`, such as `AC-T1_20230625_053500.wav`. All recordings designated for processing were directly uploaded to WildTrax and can be downloaded from the platform's Recording tab, accessible under Manage \> Download list of recordings (see @fig-download-recs). Data processing also took place in WildTrax, using the 1SPT method (species-individual per task or time to first detection) with the goal to describe the acoustic community of species heard. The full acoustic community was analyzed including birds, mammals, amphibians, including a relative environment noise assessment (i.e. wind, rain and anthropogenic noise) To ensure balanced replication at prescribed burn locations, four randomly selected recordings were processed for 3-minutes during the morning hours of 5:00 AM - 7:59 AM ideally on four separate dates.

![Downloading a list of recordings from WildTrax](./assets/download-recs.png){#fig-download-recs}

Tags were made using count-removal (see @farnsworth2002removal, @time-removal) where tags are only made at the time of first detection of each individual heard on the recordings. In case a species was overly abundant a TMTT ('too many to tag') flag was used (see @tbl-tmtt). `r round((nrow(tmtt_tags)/nrow(knpr_main))*100,4)`% of the total tags were TMTT but were subsequently converted to numeric using `wildrtrax::wt_replace_tmtt`. We also verified that all tags that were created were checked by a second observer (n = `r verified_tags |> select(Proportion) |> slice(2) |> pull()`%) to ensure accuracy of detections (see @tbl-verified). Data from 2009 - 2014 were not uploading to WildTrax or verified since the audio was not found. Amphibian abundance was estimated at the time of first detection using the [North American Amphibian Monitoring Program](https://www.usgs.gov/centers/eesc/science/north-american-amphibian-monitoring-program) with abundance of species being estimated on the scale of "calling intensity index" (CI) of 1 - 3. Vocalizing mammals such as Red Squirrel, were also noted if heard on the recordings. After the data are processed in WildTrax, the [wildrtrax](https://abbiodiversity.github.io/wildrtrax/) package is use to download the data into a standard format prepared for analysis. The `wt_download_report` function downloads the data directly to a R framework for easy manipulation (see [wildrtrax APIs](https://abbiodiversity.github.io/wildrtrax/articles/apis.html)).

```{r}
#| warning: false
#| echo: true
#| message: false
#| eval: true
#| include: true
#| code-fold: true
#| label: tbl-verified
#| tbl-cap: Proportion of tags verified

all_tags <- knpr_main |>
  filter(project_id %in% c(3163,3178,2317,NA)) |>
  tally() |>
  pull()

verified_tags <- knpr_main |>
  filter(project_id %in% c(3163,3178,2317,NA)) |>
  group_by(tag_is_verified) |>
  tally() |>
  ungroup() |>
  mutate(Proportion = round(n / all_tags,4)*100) |>
  rename("Count" = n) |>
  rename("Tag is verified" = tag_is_verified)

kable(verified_tags)
```

```{r}
#| warning: false
#| echo: true
#| message: false
#| eval: true
#| include: true
#| code-fold: true
#| label: tbl-tmtt
#| tbl-cap: TMTT tags

tmtt_tags <- knpr_main |>
  select(location, recording_date_time, species_code, individual_count) |>
  distinct() |>
  filter(individual_count == "TMTT")

kable(tmtt_tags)

```

## Analysis

Analyses were conducted in R 4.4.2 'Pile of Leaves' and in RStudio. Analysis was repeated following @Petrikeev2019analysis under the four different scenarios. Four medium-distance migrants were selected (Dark-eyed Junco (DEJU) *Junco hyemalis*, Yellow-rumped Warbler (YRWA) *Setophaga coronata*, Varied Thrush (VATH) *Ixoreus navieus*, Swainson's Thrush (SWTH) *Cathartus guttatus*) representing approximately `r round(prop_auriol*100, 2)`% of the total detections of the Auriol Trail dataset. We generated linear models of each of the four different scenarios to determine whether there was a significant change in each metric over the period between 2009 - 2013, 2014-2019 and 2020-2024, and computed power using the [`pwr`](https://cran.r-project.org/web/packages/pwr/pwr.pdf) package using *R*<sup>2</sup> and *F*<sup>2</sup> values.

* Scenario 1: Has the abundance of Dark-eyed Junco, Yellow-rumped Warbler, Varied Thrush and Swainson's Thrush per location remained within 1 standard deviation of the base metric?
* Scenario 2: Has the annual count of Dark-eyed Junco, Yellow-rumped Warbler, Varied Thrush and Swainson's Thrush remained within 1 standard deviation of the base metric?
* Scenario 3: Has the abundance of all species per location remained within 1 standard deviation of the base metric?
* Scenario 4: Has the annual count of all species remained within 1 standard deviation of the base metric?

To determine whether there was a significant difference in species richness between control and pre-burn monitoring sites, a Welch two-sample *t*-test was conducted to compare mean species richness between different treatments, using the Treatment variable as the grouping factor. 

## Bat Methods

Full-spectrum recordings were collected at the two locations at Alder Creek and Jarvis River and processed using two automatic classifiers: [Kaleidoscope](https://www.wildlifeacoustics.com/products/kaleidoscope-pro)'s Bats of North America (version 5.4.0) classifier and [Sonobat](https://sonobat.com/)'s (version 3.0) Northwestern British Columbia classifier. The classifier settings are detailed in (@sec-appendix). Based on species ranges and prior detections (@slough2023little), manual identification using Kaleidoscope results was limited to Big brown bat (*Eptesicus fuscus*), Eastern red bat (*Lasiurus borealis*), silver-haired bat (*Lasionycteris noctivagans*), and Little brown bat (*Myotis lucifugus*).

All recordings assigned a species by Kaleidoscope or Sonobat were further reviewed and manually vetted. Species identifications were compared against call parameters described by @slough2023little, @solick2022coat, and @Szewczak2024western_na_bat_acoustic_table and adhered to NABat vetting standards from @reichert2018guide.

# Results

A list of detected species and their proportions within the total data set can be found at @tbl-bird-guilds, with the seasonal detection activity of common species summarized in @fig-spp-activity.

```{r}
#| warning: false
#| echo: true
#| eval: true
#| message: false
#| include: true
#| label: tbl-bird-guilds
#| tbl-cap: Common forest bird species detected
#| code-fold: true

guilds <- read_csv("./assets/bird_guilds.csv") |>
  select(species_common_name, habitat_nesting) |>
  filter(habitat_nesting %in% c("CW","MW","OW","TSS"))

common <- knpr_main |>
  group_by(species_code) |>
  add_tally() |>
  ungroup() |>
  select(species_code, species_common_name, n) |>
  distinct() |>
  filter(!grepl('^UN|DOGG|HIGHF|UBAT|UCRS', species_code), 
         species_code != "NONE", 
         species_code != "NOISE",
         !(grepl('Noise',species_common_name)),
         species_code != "40KMYO") |>
  arrange(species_code) |>
  mutate(proportion = (round(n / sum(n),4))*100) |>
  rename(`Count of detections` = "n") |>
  rename(`Proportion of total detections` = "proportion") |>
  rename(`Species Common Name` = "species_common_name") |>
  rename(`Species Code` = "species_code")

kable(common) |>
  kable_styling(fixed_thead = TRUE) |>
  scroll_box(width = "100%", height = "400px")

```

```{r}
#| warning: false
#| echo: true
#| eval: true
#| message: false
#| include: true
#| results: hide
#| fig-align: center
#| fig-cap: Seasonal detection activity of most commonly detected forest species
#| label: fig-spp-activity
#| cap-location: bottom
#| code-fold: true

knpr_main |>
  wt_tidy_species(remove = c("mammal","amphibian","abiotic","insect","unknown"), zerofill = T) |>
  select(location, recording_date_time, species_common_name, species_code, individual_count) |>
  mutate(julian = yday(recording_date_time),
         month= month(recording_date_time),
         year = factor(year(recording_date_time))) |>
  inner_join(guilds |> select(species_common_name, habitat_nesting)) |>
  arrange(species_code) |>
  filter(habitat_nesting %in% c("CW","MW","OW","TSS")) |>
  group_by(species_code) |>
  add_tally() |>
  ungroup() |>
  mutate(habitat_nesting = case_when(
    habitat_nesting == "CW" ~ "Coniferous Woodland",
    habitat_nesting == "MW" ~ "Mixedwood",
    habitat_nesting == "OW" ~ "Open Woodland",
    habitat_nesting == "TSS" ~ "Tree Shrub / Swamp",
    TRUE ~ as.character(habitat_nesting)
  )) |>
  rename("Nesting habitat" = habitat_nesting) |>
  group_by(julian, species_common_name) |>
  add_tally() |>
  ungroup() |>
  filter(!n < 3) |>
  arrange(species_code) |>
  mutate(recording_date_time = as.POSIXct(recording_date_time)) |>
  mutate(species_code = factor(species_code, levels = sort(unique(species_code)))) |>
  ggplot(aes(x = julian, y = species_code, fill = `Nesting habitat`)) + 
  geom_density_ridges(alpha = 0.2, scale = 2.5, rel_min_height = 0.01) +
  scale_fill_viridis_d(option = "mako") +
  theme_bw() +
  xlab("Day of Year (Julian Date)") + 
  ylab("Species")

```

## Ecological integrity trends along Auriol Trail

The trend in the mean abundance of individuals per location for all species over the years is illustrated in @fig-spp-mean-abundance-all, showing no significant decline across the observed years. Species richness per location trends can be seen at @fig-spp-rich-locs. Mean abundance trends of medium-distance migrants are at @fig-relative-abundance-auriol. Annual count of medium-distance migrants is found at @fig-annual-auriol-count with a significant decrease found, however their mean abundance per year at @fig-mean-auriol-abundance was not found to be significantly changing. Mean Shannon diversity remained relative stable across years but showed increased variance over years as seen in @fig-shannon with woodpeckers (Piciformes) and landfowl (Galliformes) removed to follow methods in @Petrikeev2019analysis.

```{r}
#| warning: false
#| message: false
#| echo: true
#| eval: true
#| include: true
#| fig-align: center
#| fig-cap: Mean number of individuals for all forest species detected
#| label: fig-spp-mean-abundance-all
#| cap-location: bottom
#| code-fold: true

tot_all <- knpr_main |>
  inner_join(locs_summary |> select(Location, Site), by = c("location" = "Location")) |> 
  wt_tidy_species(remove = c("mammal","amphibian","abiotic","insect","unknown"), zerofill = T)

plot_all <- tot_all |>
  mutate(year = year(recording_date_time)) |>
  wt_replace_tmtt(calc = "round") |>
  select(location, year, species_code, individual_order, individual_count) |>
  group_by(location, year, species_code) |>
  summarise(individual_order = mean(individual_order)) |>
  ungroup() |>
  mutate(year = round(year,0))

linear_model_plot_all <- lm(individual_order ~ year, data = plot_all)
slope_plot_all <- coef(linear_model_plot_all)[2]
p_value_plot_all <- summary(linear_model_plot_all)$coefficients[2, 4]

plot_all |>
  ggplot(aes(x = year, y = individual_order)) +
  geom_point(size = 2, color = "darkblue") +
  geom_smooth(aes(x = as.numeric(as.character(year))), method = "lm") +  
  scale_colour_viridis_d() +  
  theme_bw() +
  labs(x = "Year", y = "Mean number of individuals per location") +
  scale_x_continuous(breaks = unique(plot_all$year)) +
  annotate("text", x = 2009, y = max(plot_all$individual_order), 
           label = paste("Slope: ", round(slope_plot_all,4), "\nP-value: ", round(p_value_plot_all, 4)), 
           size = 3, hjust = 0, vjust = 1)

```

```{r}
#| warning: false
#| message: false
#| echo: true
#| eval: true
#| include: true
#| fig-align: center
#| fig-cap: Species richness along Auriol Trail by year
#| label: fig-spp-rich-locs
#| cap-location: bottom
#| code-fold: true

spp_rich_location <- knpr_main |>
  as_tibble() |>
  wt_tidy_species(remove = c("mammal","amphibian","abiotic","insect","unknown"), zerofill = T) |>
  mutate(year = year(recording_date_time)) |>
  select(location, year, species_code) |>
  distinct() |>
  inner_join(locs_summary |> select(Location, Site), by = c("location" = "Location")) |>
  filter(Site == "Auriol Trail") |>
  group_by(location, Site, year) |>
  summarise(species_count = n_distinct(species_code)) |>
  ungroup()

spp_rich_location |>
  ggplot(aes(x=as.factor(year), y=species_count, fill=year)) +
  geom_boxplot() +
  geom_point(alpha = 0.7, colour = "grey") +
  geom_smooth(method = "lm") +
  theme_bw() +
  scale_fill_viridis_c(option = "mako") +
  xlab('Year') + ylab('Species richness per location')

```

```{r}
#| warning: false
#| echo: true
#| eval: true
#| message: false
#| include: true
#| results: hide
#| fig-align: center
#| fig-cap: Abundance of medium-distance migrants along Auriol Trail by year
#| label: fig-relative-abundance-auriol
#| cap-location: bottom
#| code-fold: true

# Medium-distance migrants
mdm <- c("SWTH","DEJU","VATH", "YRWA")

tot_auriol <- knpr_main |>
  filter(Site == "Auriol Trail") |>
  wt_tidy_species(remove = c("mammal","amphibian","abiotic","insect","unknown"), zerofill = T)

tot_auriol_mdm <- tot_auriol |>
  filter(species_code %in% mdm)

prop_auriol <- nrow(tot_auriol_mdm) / nrow(tot_auriol)

plot_mdm <- tot_auriol_mdm |>
  mutate(year = year(recording_date_time)) |>
  wt_replace_tmtt(calc = "round") |>
  select(location, year, species_code, individual_order, individual_count) |>
  group_by(location, year, species_code) |>
  summarise(individual_order = mean(individual_order)) |>
  ungroup() |>
  mutate(year = round(year,0))

plot_mdm |>
  ggplot(aes(x = year, y = individual_order, colour = species_code)) +
  geom_point() +
  geom_smooth(aes(x = as.numeric(as.character(year))), method = "lm") +  # Use numeric conversion for geom_smooth
  scale_colour_viridis_d(option = "mako") +  # Viridis color palette for clarity
  theme_bw() +
  facet_wrap(~species_code) +  # Free y-scale for better readability
  scale_x_continuous(breaks = unique(plot_mdm$year)) +
  labs(x = "Year", y = "Mean number of individuals per location") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))

```

```{r}
#| warning: false
#| echo: true
#| eval: true
#| message: false
#| include: true
#| results: hide
#| fig-align: center
#| fig-cap: Annual count of medium-distance migrants along Auriol Trail
#| label: fig-annual-auriol-count
#| cap-location: bottom
#| code-fold: true

count_annual_mdm <- tot_auriol_mdm |>
  mutate(year = year(recording_date_time)) |>
  wt_replace_tmtt(calc = "round") |>
  select(location, year, species_code, individual_order, individual_count) |>
  group_by(location, year, species_code) |>
  summarise(individual_order = max(individual_order)) |>
  ungroup() |>
  mutate(year = round(year,0)) |>
  group_by(year) |>
  summarise(sum_year = sum(individual_order)) |>
  ungroup()

linear_model_count_annual_mdm <- lm(sum_year ~ year, data = count_annual_mdm)
slope_count_annual_mdm <- coef(linear_model_count_annual_mdm)[2]
p_value_count_annual_mdm <- summary(linear_model_count_annual_mdm)$coefficients[2, 4]

ggplot(count_annual_mdm, aes(x = year, y = sum_year)) +
  geom_smooth(method = "lm") +
  geom_point(size = 2, color = "darkblue") +
  scale_fill_viridis_d(option = "mako") +
  labs(x = "Location", y = "Count of medium-distance migrants", fill = "Year") +
  scale_x_continuous(breaks = unique(count_annual_mdm$year)) +
  theme_bw() +
  ylim(0, 120) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  annotate("text", x = 2021, y = max(count_annual_mdm$sum_year), 
           label = paste("Slope: ", round(slope_count_annual_mdm, 2), "\nP-value: ", round(p_value_count_annual_mdm, 4)), 
           size = 3, hjust = 0, vjust = 1)

```

```{r}
#| warning: false
#| echo: true
#| eval: true
#| message: false
#| include: true
#| results: hide
#| fig-align: center
#| fig-cap: Trend in mean abundance of medium-distance migrants along on Auriol Trail
#| label: fig-mean-auriol-abundance
#| cap-location: bottom
#| code-fold: true

mean_abundance_mdm <- plot_mdm |>
  group_by(location, year) |>
  summarise(mean_abundance = mean(individual_order, na.rm = TRUE), .groups = "drop") |>
  ungroup() |>
  group_by(year) |>
  summarise(mean_abundance_year = mean(mean_abundance, na.rm = TRUE), .groups = "drop") |>
  ungroup()

linear_model_mean_abundance_mdm <- lm(mean_abundance_year ~ year, data = mean_abundance_mdm)
slope_mean_abundance_mdm <- coef(linear_model_mean_abundance_mdm)[2]
p_value_mean_abundance_mdm <- summary(linear_model_mean_abundance_mdm)$coefficients[2, 4]

ggplot(mean_abundance_mdm, aes(x = year, y = mean_abundance_year)) +
  geom_smooth(method = "lm") +
  geom_point(size = 2, color = "darkblue") +
  labs(x = "Year", y = "Mean abundance per year of medium-distance migrants") +
  scale_x_continuous(breaks = unique(mean_abundance_mdm$year)) +  # Use the correct x-axis variable
  theme_bw() +
  ylim(0.5, 2.5) +
  annotate("text", x = 2009, y = 2.25, 
           label = paste("Slope: ", round(slope_mean_abundance_mdm, 2), "\nP-value: ", round(p_value_mean_abundance_mdm, 4)), 
           size = 3, hjust = 0, vjust = 1)
  

```

```{r}
#| warning: false
#| echo: true
#| eval: true
#| message: false
#| include: true
#| results: hide
#| fig-align: center
#| fig-cap: Shannon diversity index over years on Auriol Trail
#| label: fig-shannon
#| cap-location: bottom
#| code-fold: true

shannon_d <- knpr_main |> 
  as_tibble() |>
  wt_tidy_species(remove = c("mammal","amphibian","abiotic","insect","unknown"), zerofill = T) |>
  inner_join(wt_get_species() |> select(species_code, species_class, species_order), by = "species_code") |>
  filter(Site == "Auriol Trail",
         !species_order %in% c("Piciformes","Galliformes")) |>
  wt_replace_tmtt() |>
  select(location, recording_date_time, species_code, species_common_name, individual_order, individual_count) |>
  distinct() |>
  group_by(location, recording_date_time, species_code, species_common_name) |>
  summarise(count = max(individual_order)) |>
  ungroup() |>
  pivot_wider(names_from = species_code, values_from = count, values_fill = 0) |>
  as.data.frame()

shannon <- shannon_d |>
  pivot_longer(cols = -(location:species_common_name), names_to = "species", values_to = "count") |>
  group_by(location, year = year(recording_date_time), species) |>
  summarise(total_count = sum(count)) |>
  ungroup() |>
  filter(!total_count == 0) |>
  group_by(location, year) |>
  summarise(shannon_index = diversity(total_count, index = "shannon")) |>
  ungroup() |>
  ggplot(aes(x = factor(year), y = shannon_index, fill = factor(year))) +
  geom_boxplot() +
  geom_point(alpha = 0.6, colour = "grey") +
  labs(x = "Year",
       y = "Shannon diversity index per location") +
  theme_bw() +
  guides(fill = guide_legend(title = "Year")) +
  scale_fill_viridis_d(alpha = 0.8, option = "mako")

shannon
```

```{r}
#| warning: false
#| echo: false
#| eval: true
#| message: false
#| include: false
#| label: tbl-old

lm_results <- old_standardized |> 
  filter(recording_date_time >= "2009-01-01" & recording_date_time <= "2013-12-31") |>
  group_by(location, recording_date_time, species_common_name) |>
  summarise(individual_order = max(individual_order, na.rm = TRUE)) |>
  ungroup() |>
  group_by(location, recording_date_time) |>
  summarise(sum_individuals = sum(individual_order, na.rm = TRUE)) |>
  ungroup() |>
  mutate(year = year(recording_date_time)) |>
  group_by(location, year) |>
  summarise(mean = mean(sum_individuals)) |>
  ungroup()

lm_fit <- lm(mean ~ year, data = lm_results)
p_value <- summary(lm_fit)$coefficients[2, 4]
slope <- summary(lm_fit)$coefficients[2, 1]

# ggplot(lm_results, aes(x = year, y = mean)) +
#   geom_smooth(method = "lm") +
#   theme_bw()

old_measures <- tibble(
  Field = c("Total bird abundance", "Medium distance migrants", "Modified ShannonWeiner"),
  measurement = c(15.98, 9.25, 2.06),
  Mean_2009_13 = c(5.42, 4.34, 0.47),
  STD_T2 = c(10.56, 4.91, 1.59),
  T1_2019 = c(5.14, 0.57, 1.12),
  Measure_Value = c(13.58, 8.00, 2.25),
  Status = c("Good", "Good", "Good"),
  Trend = c("↔", "↔", "↔"),
  P_value = c(0.22, 0.63, 0.5),
  Power = c(0.43, 0.71, 0.21)
)

# Scenario 1 data
scenario_1 <- tibble(
  Field = "4 common species (abundance by station)",
  Mean_2009_13 = 10.78,
  STD_T2 = 1.68,
  T1_2019 = 9.10,
  Measure_Value = 7.42,
  Status = "Good",
  Trend = "↓",
  P_value = 0.18,
  Power = 0.28
)

# Scenario 2 data
scenario_2 <- tibble(
  Field = "4 common species (count per year)",
  Mean_2009_13 = 129.40,
  STD_T2 = 20.18,
  T1_2019 = 109.22,
  Measure_Value = 89.04,
  Status = "Good",
  Trend = "↔",
  P_value = 0.27,
  Power = 0.2,
  Years_to_achieve_0.8_power = 12
)

scenario_3 <- tibble(
  Species = c("DEJU", "SWTH", "VATH", "YRWA"),
  Mean_2009_13 = c(1.66, 4.60, 1.19, 3.38),
  STD_T2 = c(1.01, 1.17, 0.55, 0.24),
  T1_2019 = c(1.50, 4.14, 1.07, 3.05),
  Measure_Value = c(1.33, 3.68, 0.95, 2.71),
  Status = c("Good", "Good", "Poor", "Good"),
  Trend = c("↔", "↔", "↓", "↔"),
  P_value = c(0.78, 0.80, 0.01, 0.90),
  Power = c(0.27, 0.90, 0.93, 0.20)
)

scenario_4 <- tibble(
  Species = c("DEJU", "SWTH", "VATH", "YRWA"),
  Mean_2009_13 = c(19.60, 55.20, 14.00, 40.60),
  STD_T2 = c(12.12, 14.10, 6.56, 2.88),
  T1_2019 = c(17.64, 49.68, 12.60, 36.54),
  Measure_Value = c(15.68, 44.16, 11.20, 32.48),
  Status = c("Good", "Good", "Poor", "Good"),
  Trend = c("↔", "↔", "↔", "↔"),
  P_value = c(0.77, 0.85, 0.23, 0.89),
  Power = c(0.20, 0.52, 0.52, 0.20)
)

forest_bird_abundance <- tibble(
  Category = c(
    "Total bird abundance", 
    "Abundance of the medium-distance migrants", 
    "Modified Shannon-Weiner", 
    "Scenario 1 (abundance of 4 spp. per station)", 
    "Scenario 2 (overall count, 4 spp. per year)", 
    "Scenario 3 - DEJU", 
    "Scenario 3 - SWTH", 
    "Scenario 3 - VATH", 
    "Scenario 3 - YRWA", 
    "Scenario 4 - DEJU", 
    "Scenario 4 - SWTH", 
    "Scenario 4 - VATH", 
    "Scenario 4 - YRWA"
  ),
  Change_Percent_2009_2019 = c(
    "-4.76%", "-1.09%", "1.84%", "-0.26%", "-0.26%", 
    "-4.98%", "3.60%", "-14.57%", "0.26%", "-4.13%", "3.60%", "-15.39%", "0.26%"
  ),
  Mean_Annual_Change = c(
    -1.28, -3.22, -0.45, 0.49, 0.49, 
    -1.52, 3.14, -9.88, -0.07, -0.43, 3.14, -10.25, -0.07
  ),
  Samples_2009_2019 = c(
    96, 96, 96, 96, 96, 
    96, 96, 96, 96, 96, 96, 96, 96
  ),
  Power_2019 = c(
    0.43, 0.71, 0.21, 0.28, 0.23, 
    0.27, 0.90, 0.93, 0.20, 0.20, 0.52, 0.52, 0.20
  ),
  Samples_to_Obtain_0.8_Power = c(
    312, 125, 708, 1081, 237, 
    1383, NA, NA, 112910, 5823, 192, 192, 6377
  ),
  Years_to_0.8_Power_with_12_Stations = c(
    18, 2, 51, 82, 12, 
    107, NA, NA, 9401, 477, 8, 8, 523
  )
)

#kable(old_measures)
#kable(scenario_1)
#kable(scenario_2)
#kable(scenario_3)
#kable(scenario_4)
#kable(forest_bird_abundance)

```

```{r}
#| warning: false
#| echo: false
#| eval: true
#| message: false
#| include: true
#| fig-align: center
#| tbl-cap: Repeated measures from Petrikeev 2019. 
#| label: fig-repeated
#| cap-location: bottom

# Preprocess data
scenario_prep <- knpr_main |>
    filter(Site == "Auriol Trail") |>
  mutate(year = year(recording_date_time)) |>
  select(location, year, recording_date_time, species_code, individual_order, individual_count) |>
  filter(!grepl('^UN|DOGG|HIGHF|UBAT|UCRS|MYOLUC', species_code), 
         species_code != "NONE", 
         species_code != "NOISE",
         species_code != "40KMYO") |>
  mutate(spl = case_when(year %in% c(2009:2013) ~ "2009 - 2013",
                         year %in% c(2014:2019) ~ "2014 - 2019",
                         year %in% c(2020:2024) ~ "2020 - 2024",
                         TRUE ~ NA_character_))

# Scenario 1 - Abundance of 4 spp. per location
kmp_scenario_1 <- scenario_prep |>
  filter(species_code %in% mdm) |>
  group_by(spl, location, year, recording_date_time, species_code) |>
  summarise(individual_order = max(individual_order)) |>
  ungroup() |>
  group_by(spl, location, year) |>
  summarise(sum = sum(individual_order)) |>
  ungroup() |>
  group_by(spl) |>
  mutate(mean_period = mean(sum),
         sd_period = sd(sum, na.rm = TRUE),
         sample_size_period = n(),
         T2 = mean_period - sd_period,
         T1 = mean_period - (2 * sd_period)) |>
  ungroup()

# Scenario 2 - Annual count of 4 spp. 
kmp_scenario_2 <- scenario_prep |>
  filter(species_code %in% mdm) |>
  group_by(spl, location, year, recording_date_time, species_code) |>
  summarise(individual_order = max(individual_order)) |>
  ungroup() |>
  group_by(spl, year) |>
  summarise(count = sum(individual_order)) |>
  ungroup() |>
  group_by(spl) |>
  mutate(mean_period = mean(count),
         sd_period = sd(count, na.rm = TRUE),
         sample_size_period = n(),
         T2 = mean_period - sd_period,
         T1 = mean_period - (2 * sd_period)) |>
  ungroup()

# Scenario 3 - Abundance of all spp. per location
kmp_scenario_3 <- scenario_prep |>
  filter(!species_code %in% c("CORA","YEWA","WISN")) |>
  group_by(spl, location, year, recording_date_time, species_code) |>
  summarise(individual_order = max(individual_order)) |>
  ungroup() |>
  group_by(spl, location, year) |>
  summarise(sum = sum(individual_order)) |>
  ungroup() |>
  group_by(spl) |>
  mutate(mean_period = mean(sum),
         sd_period = sd(sum, na.rm = TRUE),
         sample_size_period = n(),
         T2 = mean_period - sd_period,
         T1 = mean_period - (2 * sd_period)) |>
  ungroup()
  

# Scenario 4 - Annual count of all spp
kmp_scenario_4 <- scenario_prep |>
  filter(!species_code %in% c("CORA","YEWA","WISN")) |>
  group_by(spl, location, year, recording_date_time, species_code) |>
  summarise(individual_order = max(individual_order)) |>
  ungroup() |>
  group_by(spl, year) |>
  summarise(count = sum(individual_order)) |>
  ungroup() |>
  group_by(spl) |>
  mutate(mean_period = mean(count),
         sd_period = sd(count, na.rm = TRUE),
         sample_size_period = n(),
         T2 = mean_period - sd_period,
         T1 = mean_period - (2 * sd_period)) |>
  ungroup()

# Build Models for Scenarios 1-4
model_scenario_1 <- lm(sum ~ spl + location, data = kmp_scenario_1)
model_scenario_2 <- lm(count ~ spl, data = kmp_scenario_2)
model_scenario_3 <- lm(sum ~ spl + location, data = kmp_scenario_3)
model_scenario_4 <- lm(count ~ spl, data = kmp_scenario_4)

# Calculate Mean, SD, T1, T2 for Scenarios 1, 2, 3, 4
ks1 <- kmp_scenario_1 %>%
  summarise(mean_val = mean(sum),
            sd_val = sd(sum),
            T2 = mean_val - sd_val,
            T1 = mean_val - (2 * sd_val))

ks2 <- kmp_scenario_2 %>%
  summarise(mean_val = mean(count),
            sd_val = sd(count),
            T2 = mean_val - sd_val,
            T1 = mean_val - (2 * sd_val))

ks3 <- kmp_scenario_3 %>%
  summarise(mean_val = mean(sum),
            sd_val = sd(sum),
            T2 = mean_val - sd_val,
            T1 = mean_val - (2 * sd_val))

ks4 <- kmp_scenario_4 %>%
  summarise(mean_val = mean(count),
            sd_val = sd(count),
            T2 = mean_val - sd_val,
            T1 = mean_val - (2 * sd_val))

# P-values for Models
pmodel1 <- summary(model_scenario_1)$coefficients[, 4]
pmodel2 <- summary(model_scenario_2)$coefficients[, 4]
pmodel3 <- summary(model_scenario_3)$coefficients[, 4]
pmodel4 <- summary(model_scenario_4)$coefficients[, 4]

# Statistical Power Calculation
rsq_1 <- summary(model_scenario_1)$r.squared
f_squared_1 <- rsq_1 / (1 - rsq_1)
n_1 <- nrow(kmp_scenario_1 |> select(spl, location, sum) |> distinct())
power_1 <- pwr.f2.test(u = length(coef(model_scenario_1)) - 1,  
                       v = n_1 - length(coef(model_scenario_1)),  
                       f2 = f_squared_1,  
                       sig.level = 0.8)

rsq_2 <- summary(model_scenario_2)$r.squared
f_squared_2 <- rsq_2 / (1 - rsq_2)
n_2 <- nrow(kmp_scenario_2 |> select(spl, count) |> distinct())
power_2 <- pwr.f2.test(u = length(coef(model_scenario_2)) - 1,  
                       v = n_2 - length(coef(model_scenario_2)),  
                       f2 = f_squared_2,  
                       sig.level = 0.8)

rsq_3 <- summary(model_scenario_3)$r.squared
f_squared_3 <- rsq_3 / (1 - rsq_3)
n_3 <- nrow(kmp_scenario_3 |> select(spl, location, sum) |> distinct())
power_3 <- pwr.f2.test(u = length(coef(model_scenario_3)) - 1,  
                       v = n_3 - length(coef(model_scenario_3)),  
                       f2 = f_squared_3,  
                       sig.level = 0.8)

rsq_4 <- summary(model_scenario_4)$r.squared
f_squared_4 <- rsq_4 / (1 - rsq_4)
n_4 <- nrow(kmp_scenario_4 |> select(spl, count) |> distinct())
power_4 <- pwr.f2.test(u = length(coef(model_scenario_4)) - 1,  
                       v = n_4 - length(coef(model_scenario_4)),  
                       f2 = f_squared_4,  
                       sig.level = 0.8)

# Pooled T-test for Julian Date Effect
kmp_scenarios <- list(kmp_scenario_1, kmp_scenario_2, kmp_scenario_3, kmp_scenario_4)

# Define time periods
time_periods <- list(
  "2009-2013" = 2009:2013,
  "2014-2019" = 2014:2019,
  "2020-2024" = 2020:2024
)

perform_t_tests <- function(data, periods) {
  # Filter data by time periods
  filtered_data <- map(periods, ~ filter(data, year %in% .x))
  
  # Check for NULL or empty filtered data
  if (any(map_lgl(filtered_data, ~ nrow(.x) == 0 || is.null(.x$sum)))) {
    return(tibble(
      Comparison = c("2009-2013 vs 2014-2019", "2014-2019 vs 2020-2024", "2009-2013 vs 2020-2024"),
      p_value = NA,
      mean_diff = NA
    ))
  }
  
  # Perform t-tests
  results <- tibble(
    Comparison = c("2009-2013 vs 2014-2019", "2014-2019 vs 2020-2024", "2009-2013 vs 2020-2024"),
    T_Test = list(
      t.test(filtered_data[["2009-2013"]]$sum, filtered_data[["2014-2019"]]$sum),
      t.test(filtered_data[["2014-2019"]]$sum, filtered_data[["2020-2024"]]$sum),
      t.test(filtered_data[["2009-2013"]]$sum, filtered_data[["2020-2024"]]$sum)
    )) %>%
    mutate(
      p_value = map_dbl(T_Test, ~ .x$p.value),
      mean_diff = map_dbl(T_Test, ~ .x$estimate[1] - .x$estimate[2])
    ) %>%
    select(-T_Test)  # Drop the raw test objects if not needed
  
  return(results)
}

power_analyze <- tibble(
  Scenario = c("Abundance of 4 spp.", "Annual count of 4 spp.", "Abundance of all spp.", "Annual count all spp."),
  `Mean abundance baseline (2009 - 2013)` = c(kmp_scenario_1 |> 
                       filter(spl == "2009 - 2013") |> 
                       select(mean_period) |> 
                       distinct() |> 
                       pull(), 
                     kmp_scenario_2 |> 
                       filter(spl == "2009 - 2013") |> 
                       select(mean_period) |> 
                       distinct() |> 
                       pull(), 
                     kmp_scenario_3 |> 
                       filter(spl == "2009 - 2013") |> 
                       select(mean_period) |> 
                       distinct() |> 
                       pull(), 
                     kmp_scenario_4 |> 
                       filter(spl == "2009 - 2013") |> 
                       select(mean_period) |> 
                       distinct() |> 
                       pull()),
  SD = c(kmp_scenario_1 |> 
                       filter(spl == "2009 - 2013") |> 
                       select(sd_period) |> 
                       distinct() |> 
                       pull(), 
                     kmp_scenario_2 |> 
                       filter(spl == "2009 - 2013") |> 
                       select(sd_period) |> 
                       distinct() |> 
                       pull(), 
                     kmp_scenario_3 |> 
                       filter(spl == "2009 - 2013") |> 
                       select(sd_period) |> 
                       distinct() |> 
                       pull(), 
                     kmp_scenario_4 |> 
                       filter(spl == "2009 - 2013") |> 
                       select(sd_period) |> 
                       distinct() |> 
                       pull()),
  T2 = c(kmp_scenario_1 |> filter(spl == "2009 - 2013") |> select(T2) |> distinct(),
         kmp_scenario_2 |> filter(spl == "2009 - 2013") |> select(T2) |> distinct(),
         kmp_scenario_3 |> filter(spl == "2009 - 2013") |> select(T2) |> distinct(),
         kmp_scenario_4 |> filter(spl == "2009 - 2013") |> select(T2) |> distinct()),
  T1 = c(kmp_scenario_1 |> filter(spl == "2009 - 2013") |> select(T1) |> distinct(),
         kmp_scenario_2 |> filter(spl == "2009 - 2013") |> select(T1) |> distinct(),
         kmp_scenario_3 |> filter(spl == "2009 - 2013") |> select(T1) |> distinct(),
         kmp_scenario_4 |> filter(spl == "2009 - 2013") |> select(T1) |> distinct()),
  `Mean abundance second period (2014 - 2019)` = c(kmp_scenario_1 |> 
                       filter(spl == "2014 - 2019") |> 
                       select(mean_period) |> 
                       distinct() |> 
                       pull(), 
                     kmp_scenario_2 |> 
                       filter(spl == "2014 - 2019") |> 
                       select(mean_period) |> 
                       distinct() |> 
                       pull(), 
                     kmp_scenario_3 |> 
                       filter(spl == "2014 - 2019") |> 
                       select(mean_period) |> 
                       distinct() |> 
                       pull(), 
                     kmp_scenario_4 |> 
                       filter(spl == "2014 - 2019") |> 
                       select(mean_period) |> 
                       distinct() |> 
                       pull()),
  `SD (2014 - 2019)` = c(kmp_scenario_1 |> 
                       filter(spl == "2014 - 2019") |> 
                       select(sd_period) |> 
                       distinct() |> 
                       pull(), 
                     kmp_scenario_2 |> 
                       filter(spl == "2014 - 2019") |> 
                       select(sd_period) |> 
                       distinct() |> 
                       pull(), 
                     kmp_scenario_3 |> 
                       filter(spl == "2014 - 2019") |> 
                       select(sd_period) |> 
                       distinct() |> 
                       pull(), 
                     kmp_scenario_4 |> 
                       filter(spl == "2014 - 2019") |> 
                       select(sd_period) |> 
                       distinct() |> 
                       pull()),
  `Mean abundance third period (2020 - 2024)` = c(kmp_scenario_1 |> 
                       filter(spl == "2020 - 2024") |> 
                       select(mean_period) |> 
                       distinct() |> 
                       pull(), 
                     kmp_scenario_2 |> 
                       filter(spl == "2020 - 2024") |> 
                       select(mean_period) |> 
                       distinct() |> 
                       pull(), 
                     kmp_scenario_3 |> 
                       filter(spl == "2020 - 2024") |> 
                       select(mean_period) |> 
                       distinct() |> 
                       pull(), 
                     kmp_scenario_4 |> 
                       filter(spl == "2020 - 2024") |> 
                       select(mean_period) |> 
                       distinct() |> 
                       pull()),
  `SD (2020 - 2024)` = c(kmp_scenario_1 |> 
                       filter(spl == "2020 - 2024") |> 
                       select(sd_period) |> 
                       distinct() |> 
                       pull(), 
                     kmp_scenario_2 |> 
                       filter(spl == "2020 - 2024") |> 
                       select(sd_period) |> 
                       distinct() |> 
                       pull(), 
                     kmp_scenario_3 |> 
                       filter(spl == "2020 - 2024") |> 
                       select(sd_period) |> 
                       distinct() |> 
                       pull(), 
                     kmp_scenario_4 |> 
                       filter(spl == "2020 - 2024") |> 
                       select(sd_period) |> 
                       distinct() |> 
                       pull()),
  R_Squared = c(rsq_1, rsq_2, rsq_3, rsq_4),
  F_Squared = c(f_squared_1, f_squared_2, f_squared_3, f_squared_4),
  Sample_Size_n = c(n_1, n_2, n_3, n_4),
  Power = c(power_1$power, power_2$power, power_3$power, power_4$power)) |>
  unnest() |>
  mutate(across(where(is.numeric), \(x) round(x, digits = 2)))

kable(power_analyze)

```

```{r}
#| warning: false
#| echo: false
#| eval: true
#| message: false
#| include: true
#| fig-align: center
#| tbl-cap: Comparison table of four scenarios and the mean difference
#| label: fig-comparison
#| cap-location: bottom

results %>%
  unnest_longer(T_Test_Results) |>
  unnest_wider(T_Test_Results) |>
  mutate(across(where(is.numeric), ~ format(round(.x, digits = 2), scientific = FALSE))) |>
  mutate(Scenario = case_when(Scenario == "Scenario_1" ~ "Abundance of 4 spp.",
                              Scenario == "Scenario_2" ~ "Annual count of 4 spp.",
                              Scenario == "Scenario_3" ~ "Abundance of all spp.",
                              Scenario == "Scenario_4" ~ "Annual count all spp.")) |>
  kable()
  
```

## Pre-burn monitoring for prescribed fire

In 2023, two locations (`AC-C1, AC-T3`) failed to complete their intended recording schedules. These failures were likely caused by low batteries, SD card formatting issues, or outdated firmware (see @sec-discussion). In 2024, all locations successfully recorded their intended schedules. A total of `r nrow(common)` species were identified. @fig-prescribed-burns illustrates the relationship between species richness grouped by controls and treatments at each location, showing that species richness was equal across sites (Alder Creek, Jarvis River) and treatments combined across sites (controll, treatments). Data from 2023 and 2024 at both Alder Creek and Jarvis sites is collected prior to burning. Both the control and treatment plots are locations not yet treated with prescribed fire at the time of data collection. 

```{r}
#| warning: false
#| echo: true
#| eval: true
#| message: false
#| include: true
#| fig-align: center
#| fig-cap: Species richness for pre-burn monitoring at future prescribed fire sites
#| label: fig-prescribed-burns
#| code-fold: true

burn_data <- knpr_main |>
  filter(project_id %in% c(2317,3178)) |>
  wt_tidy_species(remove = c("amphibian","mammal","unknown","abiotic")) |>
  wt_replace_tmtt(calc = "round") |>
  mutate(year = year(recording_date_time)) |>
  select(location, year, recording_date_time, species_code, individual_order, individual_count) |>
  mutate(Treatment = case_when(str_detect(location, '-T') ~ "Prescribed Burn",
                               str_detect(location, '-C') ~ "Control",
                               grepl('BAT',location) ~ "Bat Monitoring",
                               TRUE ~ "Ecological Integrity"),
          Site = case_when(grepl('AC-*',location) ~ "Alder Creek",
                          grepl('JR-*',location) ~ "Jarvis River",
                          grepl('BAT',location) ~ "Bat Monitoring",
                          TRUE ~ NA_character_))

richness_data <- burn_data %>%
  group_by(year, Site, Treatment) %>%
  summarize(species_richness = n_distinct(species_code), .groups = "drop")

# Perform t-test for species richness between treatments
t_test_result <- t.test(species_richness ~ Treatment, data = richness_data)

# Boxplot for species richness by treatment
ggplot(richness_data, aes(x = Treatment, y = species_richness, fill = Treatment)) +
  geom_boxplot() +
  geom_point(alpha = 0.6, colour = "grey") +
  labs(x = "Treatment", y = "Species Richness") +
  theme_bw()+
  annotate("text", x = 1.5, y = max(richness_data$species_richness),
           label = paste0("p = ", signif(t_test_result$p.value, 3)),
           size = 3, color = "black") +
  scale_fill_viridis_d(option = "mako", alpha = 0.7)

```

## Bat data

The detectors ran for a total of 35 recorder nights and in total collected 8794 files, of these 8776 were classified as noise files (`r round((8776/8794)*100,2)`%), with no distinguishable bat present. Of the remaining recordings the only species identified was Little brown bat (@tbl-bat-results). Recordings that had no diagnostic criteria for any species were classified as either 40kHz Myotis (calls with consistent minimum frequency with an Fc=35-45kHz) or high frequency group (bat calls with Fc\>35kHz). No low frequency calls were recorded at either site. Due to the absence of any diagnostic calls for species other than the Little brown bat the 40kHz Myotis (40KMyo) and High Frequency (HighF) recordings were likely produced by Little brown bats.

```{r}
#| warning: false
#| echo: false
#| eval: true
#| message: false
#| include: true
#| tbl-cap: Results of manually classified recordings collected at two stations in Kluane National Park Reserve in 2024.
#| label: tbl-bat-results
#| cap-location: bottom

bat_data <- data.frame(
  `Species Group/Species` = c("Little Brown Bat", "40kHz Myotis", "High Frequency Bats", "Noise", "Total Bats"),
  Code = c("MYLU", "40KMyo", "HighF", "NOISE", ""),
  `AC Bats` = c(6, 9, 2, 1623, "17"),
  `JR Bats` = c(0, 1, 0, 7153, "1"),
  Total = c("6", "10", "2", "8776", "")
)

# Generate the kable table
kable(bat_data, align = "lcccc", escape = FALSE) %>%
  kable_styling(full_width = FALSE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))

```

# Discussion {#sec-discussion}

Abundance decreases are likely influenced by observation effects between point count and ARU data, which can be further explored through future modeling using offsetting approaches. While no significant trends were observed for the main medium-distance migrants (Swainson's Thrush, Yellow-rumped Warbler, Dark-eyed Junco), a decline in Varied Thrush was noted (see @fig-relative-abundance-auriol) in line with findings from @Petrikeev2019analysis. However, the sample size and survey scope and power are likely too small to draw definitive conclusions. 

Continued use of ARUs for monitoring is recommended, with WildTrax providing an effective way to standardize future datasets that are added. Repeating annual both Auriol Trail and Quill Creek and incorporating additional habitat types of new survey sites would enhance the robustness of medium-distance migrant data and potentially increase overall species richness in future surveys. After prescribed burns, it is anticipated that the habitat will gradually support the emergence of new guilds and species as part of its natural regeneration process, and monitoring these sites will enable tracking of these changes over time.

While the project has yielded promising results, several operational improvements are necessary to fully realize its potential moving into the next season. Key recommendations include:

-   **Extending survey window and recording schedule**: Initiating the survey window to encompass resident and early-migrant species (early May) and extending it into the post-breeding season (mid-July) will capture a comprehensive range of species. Given the diverse migration timing and breeding patterns among species, extending the window can help to add additional species whose detectability is lower. Recording bird vocalizations throughout the deployment period at various times of the day: pre-dawn, dawn, post-dawn, pre-dusk, dusk, post-dusk, and night--enables a comprehensive assessment of bird diversity and activity patterns. Birds exhibit diverse diurnal and nocturnal behaviors, with some species being more vocal during specific times of the day or night. Continuous recording across different times allows ARUs to capture a broad spectrum of species, including those that are crepuscular or nocturnal, providing valuable insights into their behaviors and habitat preferences. This approach enhances the accuracy and completeness of bird surveys, offering valuable data for planning and management efforts.

-   **Equipment maintenance and management**: Given that 3 locations failed during their deployment, ensuring that equipment is properly functioning, tested and maintained prior to deployment is crucial for ensuring the success of a long-term monitoring program. The ABMI provides [Equipment Protocols](https://ftp-public.abmi.ca/home/publications/documents/599_ABMI_2021_TerrestrialARUandRemoteCameraTrapProtocols_ABMI.pdf) to help assist in the maintenance and deployment of most [Wildlife Acoustics](https://www.wildlifeacoustics.com/) makes and models. Most importantly, ensure the units are cleaned and inspected for physical or mechanical damage, update the firmware and conduct tests to ensure functionality in a controlled environment.

-   **Localized monitoring**: Consistently deploying ARUs in the same locations on Auriol Trail, Quill Creek and Alder Creek and Jarvis River sites annually will help to establish robust monitoring sites. By continuously surveying specific areas, changes in bird distribution and abundance can be monitored which facilitates the identification of long-term trends and enables the understanding of changes in bird populations and guilds over time, especially with planned changes with the prescribed burns. Forest structure may be lost after a burn, however ARUs can be established in the same locations using different deployment methods (again see [Equipment Protocols](https://ftp-public.abmi.ca/home/publications/documents/599_ABMI_2021_TerrestrialARUandRemoteCameraTrapProtocols_ABMI.pdf)).

-   **ARU deployment in prescribed burns**: Prescribed burns should take place at least after final breeding bird populations are done nesting or before their spring arrival (see @fig-spp-activity). At least one ARU per 0.5 hectares burned ensures thorough monitoring of post-burn effects on bird populations. This density of ARU deployment generates detailed data on how bird populations respond to habitat changes following prescribed burns, facilitating the understanding of ecosystem resilience and recovery processes. By monitoring post-burn effects on bird populations, researchers can inform conservation strategies aimed at mitigating the impact of habitat disturbance. Given the guild changes seen in species communities post-burn it may be necessary to survey burned areas only at 1, 2, 3, 5 and 10 years post-burn along the length of the program.

-   **Extending analyses**: With the accumulation of additional data, it is recommended to conduct more sophisticated analyses, to effectively capture the fluctuations in species occupancy across sites over time. Exploring models aimed at examining the resilience of both individual species and community structure and dynamic occupancy models of species is suggested.

## Recommendations for bat deployments

For future deployments, it is recommended to ensure recorder settings align with the NABat protocol (@Loeb_2015). Some recordings were collected during daytime hours, suggesting the recording schedule included non-target hours. NABat standards advise recording only from 30 minutes before sunset to 30 minutes after sunrise.

Both deployment locations were positioned near sources of ultrasonic noise (@fig-bat-noise), likely contributing to the large number of noise files in the analysis. Additionally, some noise files contained potential rodent vocalizations, which may be worth noting for future analyses. If feasible, relocating the sites away from ultrasonic noise sources is recommended. Alternatively, adjusting the recorder gain settings could help reduce noise file occurrences. In 2024, the gain was set to 12; reducing it to 0 could significantly decrease noise files and extend recorder battery life. While lower gain settings may reduce the detection of quieter species, the lack of evidence for these species this year suggests the benefits would outweigh this limitation.

![Examples of environmental ultrasonic noise in AC-Bats and JR-Bats sites in 2024 deployments](./assets/bat-noise.png){#fig-bat-noise}

-   **Bat monitoring enhancements**: Continuing to use a sample rate to 256 kHz is advisable, given that bat species in western Canada typically do not vocalize beyond this frequency range. The sampling rate will also optimize the total amount of data volume collected and battery usage. It is also recommended to programming the Max Time Between Calls (TBC) by adjusting the trigger window from 3 to 2 seconds. The [North American Bat Monitoring Program](https://www.nabatmonitoring.org/) offers many additional recommendations for deployment, processing and interpretation of ultrasonic data.

# Appendix

## Appendix A: Settings used for ultrasonic classifiers {#sec-appendix}

**Kaleidoscope Settings** (**Version:** 5.6.8):

-   **Mode:** 0\
-   **Threads:** 24\
-   **Classifier Settings:**
    -   **Classifier Version**: classifiers-Bats_of_North_America_5.4.0\
    -   **ROC:** 2\
-   **Enabled Species:**
    -   EPTFUS: 1\
    -   LASBOR: 1\
    -   LASNOC: 1\
    -   MYOLUC: 1\
-   **Analysis Settings**
    -   **Frequency Minimum:** 8\
    -   **Frequency Maximum:** 120\
    -   **Duration Minimum:** 2\
    -   **Duration Maximum:** 40\
    -   **Maximum Gap:** 500\
    -   **Minimum Calls:** 1\
    -   **Filter ZC:** 1\
    -   **Remove DC:** 0\
    -   **CF Minimum Frequency:** 0\
    -   **CF Maximum Frequency:** 0\
    -   **CF Maximum Bandwidth:** 0
